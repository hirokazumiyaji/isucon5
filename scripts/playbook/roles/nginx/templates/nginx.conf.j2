worker_processes 8;
worker_rlimit_nofile 65535;

events {
  worker_connections 65535;
  multi_accept on;
}

http {
  include       /etc/nginx/mime.types;

  server_tokens off;

  log_format main '{"time": "$time_iso8601", '
                '"remote_addr": "$remote_addr", '
                '"remote_user": "$remote_user", '
                '"body_bytes_sent": $body_bytes_sent, '
                '"request_time": $request_time, '
                '"status": $status, '
                '"request": "$request", '
                '"http_referrer": "$http_referer", '
                '"http_user_agent": "$http_user_agent", '
                '"upstream_response_time": $upstream_response_time}';

  access_log  /var/log/nginx/access.log  main;
  error_log  /var/log/nginx/error.log;

  sendfile      on;
  tcp_nopush    on;
  keepalive_timeout  65;

  gzip on;
  gzip_types text/css text/javascript;

  upstream app {
    server 127.0.0.1:8080;
    # server unix:/var/run/app.sock;
  }

  server {
    location ~ ^/(stylesheets|images)/ {
      open_file_cache max=1000;
      root /home/isucon/webapp/public;
      expires 1m;
    }

    location / {
      proxy_pass http://app;
    }
  }

}
